name: AltLinux P11 - RPM

on:
  workflow_dispatch:
    inputs:
      spec_path:
        description: "Path to .spec / .spec.example inside repo (optional). Example: orions-gate.spec.example"
        required: false
        default: ""
  push:
    branches: [ "main" ]
    paths:
      - "**"
  pull_request:
    paths:
      - "**"

env:
  ARTIFACT_DIR: artifacts
  ALT_IMAGE: alt:p11

jobs:
  altlinux_rpm:
    name: AltLinux P11 — RPM (rpmbuild)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect spec (supports *.spec.example)
        id: detect
        shell: bash
        env:
          SPEC_INPUT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.spec_path || '' }}
        run: |
          set -euo pipefail

          # 1) workflow_dispatch override
          if [ -n "${SPEC_INPUT:-}" ]; then
            if [ -f "$SPEC_INPUT" ]; then
              echo "mode=spec" >> "$GITHUB_OUTPUT"
              echo "spec=$SPEC_INPUT" >> "$GITHUB_OUTPUT"
              echo "Detected: spec (from input) -> $SPEC_INPUT"
              exit 0
            fi
            echo "ERROR: Provided spec_path not found: $SPEC_INPUT" >&2
            exit 1
          fi

          # 2) Prefer tracked spec/spec.example
          SPEC_PATH="$(git ls-files | grep -iE '\.spec(\.example)?$' | head -n1 || true)"
          if [ -z "$SPEC_PATH" ]; then
            SPEC_PATH="$(find . -type f \( -iname '*.spec' -o -iname '*.spec.example' \) 2>/dev/null | head -n1 || true)"
          fi

          if [ -n "$SPEC_PATH" ]; then
            SPEC_PATH="${SPEC_PATH#./}"
            echo "mode=spec" >> "$GITHUB_OUTPUT"
            echo "spec=$SPEC_PATH" >> "$GITHUB_OUTPUT"
            echo "Detected: spec -> $SPEC_PATH"
            exit 0
          fi

          echo "ERROR: No .spec / .spec.example found in repository." >&2
          exit 1

      - name: Build RPM inside ALT Linux container (rpmbuild)
        shell: bash
        run: |
          set -euo pipefail
          docker pull "$ALT_IMAGE"

          docker run --rm \
            -v "$GITHUB_WORKSPACE:/work" \
            -w /work \
            -e SPEC_PATH="${{ steps.detect.outputs.spec }}" \
            -e ARTIFACT_DIR="${ARTIFACT_DIR}" \
            "$ALT_IMAGE" \
            bash --noprofile --norc -s <<'BASH'
          set -euo pipefail

          echo "== System =="
          cat /etc/*release || true

          echo "== Install build tools =="
          apt-get update
          # IMPORTANT: ALT apt-get doesn't support --no-install-recommends
          apt-get install -y \
            rpm rpm-build rpmspec \
            git tar gzip xz bzip2 \
            make gcc gcc-c++ \
            findutils coreutils which \
            gawk sed grep \
            ca-certificates curl rsync patch

          # Node/NPM for specs that build the app during %build
          apt-get install -y node npm || true

          echo "node=$(node -v || true) npm=$(npm -v || true)"
          echo "rpmbuild=$(rpmbuild --version | head -n1 || true)"

          echo "== Prepare rpmbuild tree (inside /work) =="
          TOPDIR="/work/rpmbuild"
          mkdir -p "$TOPDIR"/{BUILD,BUILDROOT,RPMS,SRPMS,SOURCES,SPECS}
          echo "%_topdir $TOPDIR" > /root/.rpmmacros

          SPEC="/work/${SPEC_PATH#./}"
          if [ ! -f "$SPEC" ]; then
            echo "ERROR: spec not found: $SPEC" >&2
            exit 1
          fi

          # If spec is *.spec.example — copy/rename to *.spec
          SPEC_BASE="$(basename "$SPEC")"
          if echo "$SPEC_BASE" | grep -qi '\.spec\.example$'; then
            SPEC_REAL="$TOPDIR/SPECS/${SPEC_BASE%.example}"
          else
            SPEC_REAL="$TOPDIR/SPECS/$SPEC_BASE"
          fi
          cp -v "$SPEC" "$SPEC_REAL"

          echo "== Parse Name/Version/Source0 from spec =="
          NAME="$(awk -F': *' 'tolower($1)=="name" {print $2; exit}' "$SPEC_REAL" | tr -d "\r")"
          VERSION="$(awk -F': *' 'tolower($1)=="version" {print $2; exit}' "$SPEC_REAL" | tr -d "\r")"
          SRC0_RAW="$(awk -F': *' 'tolower($1)=="source0" {print $2; exit}' "$SPEC_REAL" | tr -d "\r" || true)"

          if [ -z "${NAME:-}" ] || [ -z "${VERSION:-}" ]; then
            echo "ERROR: Cannot parse Name/Version from spec: $SPEC_REAL" >&2
            echo "---- spec head ----"
            head -n 80 "$SPEC_REAL" || true
            exit 1
          fi

          # Determine tarball filename from Source0 when it is local (not URL)
          TAR_BASENAME=""
          if [ -n "${SRC0_RAW:-}" ] && ! echo "$SRC0_RAW" | grep -qE '^[a-zA-Z]+://'; then
            TAR_BASENAME="$SRC0_RAW"
            TAR_BASENAME="${TAR_BASENAME//%{name}/$NAME}"
            TAR_BASENAME="${TAR_BASENAME//%{version}/$VERSION}"
            TAR_BASENAME="$(basename "$TAR_BASENAME")"
            # If macros still present, fallback
            if echo "$TAR_BASENAME" | grep -q '%{' ; then TAR_BASENAME=""; fi
          fi
          if [ -z "$TAR_BASENAME" ]; then
            TAR_BASENAME="${NAME}-${VERSION}.tar.gz"
          fi

          echo "Name=$NAME"
          echo "Version=$VERSION"
          echo "Source0=$SRC0_RAW"
          echo "Tarball=$TAR_BASENAME"

          echo "== Create Source0 tarball from current commit =="
          OUT="$TOPDIR/SOURCES/$TAR_BASENAME"
          case "$TAR_BASENAME" in
            *.tar.xz)
              git -C /work archive --format=tar --prefix="${NAME}-${VERSION}/" HEAD | xz -c > "$OUT"
              ;;
            *.tar.bz2)
              git -C /work archive --format=tar --prefix="${NAME}-${VERSION}/" HEAD | bzip2 -c > "$OUT"
              ;;
            *.tar)
              git -C /work archive --format=tar --prefix="${NAME}-${VERSION}/" -o "$OUT" HEAD
              ;;
            *)
              git -C /work archive --format=tar.gz --prefix="${NAME}-${VERSION}/" -o "$OUT" HEAD
              ;;
          esac
          ls -lah "$OUT" || true

          echo "== Build RPM =="
          set -x
          rpmbuild --define "_topdir $TOPDIR" -ba "$SPEC_REAL"
          set +x

          echo "== Collect artifacts =="
          mkdir -p "/work/$ARTIFACT_DIR/altlinux"
          find "$TOPDIR" -type f \( -name '*.rpm' -o -name '*.src.rpm' \) -print -exec cp -v {} "/work/$ARTIFACT_DIR/altlinux/" \; || true
          echo "== Collected =="
          ls -lah "/work/$ARTIFACT_DIR/altlinux" || true

          if ! ls "/work/$ARTIFACT_DIR/altlinux/"*.rpm >/dev/null 2>&1 && \
             ! ls "/work/$ARTIFACT_DIR/altlinux/"*.src.rpm >/dev/null 2>&1; then
            echo "ERROR: RPM not produced. Nothing to upload." >&2
            exit 1
          fi
          BASH

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: altlinux-rpm
          path: artifacts/altlinux/**
          if-no-files-found: error
          retention-days: 30
