name: Alt P11 - RPM

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main, master ]
    tags: [ "v*" ]

permissions:
  contents: read

env:
  ARTIFACT_DIR: artifacts

jobs:
  altlinux_rpm:
    name: AltLinux P11 - RPM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Locate .spec file
        id: findspec
        shell: bash
        run: |
          set -euo pipefail
          SPEC_PATH="$(find . -maxdepth 8 -type f -name '*.spec' | head -n 1 || true)"
          if [ -z "$SPEC_PATH" ]; then
            echo "ERROR: No .spec file found in repository." >&2
            exit 1
          fi
          echo "spec=$SPEC_PATH" >> "$GITHUB_OUTPUT"
          echo "Using spec: $SPEC_PATH"

      - name: Build RPM in AltLinux P11 container
        shell: bash
        env:
          SPEC_PATH: ${{ steps.findspec.outputs.spec }}
        run: |
          set -euo pipefail
          docker pull alt:p11

          docker run --rm \
            -v "$GITHUB_WORKSPACE:/work" \
            -w /work \
            -e SPEC_PATH="$SPEC_PATH" \
            alt:p11 \
            bash -lc '
              set -euo pipefail

              apt-get update
              # База для rpmbuild + node toolchain (в ALT пакеты называются node и npm)
              apt-get install -y --no-install-recommends \
                rpm rpm-build \
                git tar gzip xz \
                make gcc gcc-c++ \
                findutils coreutils \
                node npm

              echo "node: $(node -v || true)"
              echo "npm:  $(npm -v || true)"
              echo "rpmbuild: $(rpmbuild --version | head -n1)"

              TOPDIR="/work/rpmbuild"
              mkdir -p "$TOPDIR"/{BUILD,BUILDROOT,RPMS,SRPMS,SOURCES,SPECS}
              echo "%_topdir $TOPDIR" > /root/.rpmmacros

              SPEC="/work/${SPEC_PATH#./}"
              if [ ! -f "$SPEC" ]; then
                echo "ERROR: spec not found at $SPEC" >&2
                exit 1
              fi

              # Парсим Name/Version/Source0 из spec
              NAME="$(awk -F\": *\" \"tolower(\$1)==\\\"name\\\" {print \$2; exit}\" \"$SPEC\" | tr -d \"\\r\")"
              VERSION="$(awk -F\": *\" \"tolower(\$1)==\\\"version\\\" {print \$2; exit}\" \"$SPEC\" | tr -d \"\\r\")"
              SRC0_RAW="$(awk -F\": *\" \"tolower(\$1)==\\\"source0\\\" {print \$2; exit}\" \"$SPEC\" | tr -d \"\\r\" || true)"

              if [ -z "$NAME" ] || [ -z "$VERSION" ]; then
                echo "ERROR: Cannot parse Name/Version from spec" >&2
                exit 1
              fi

              TAR_BASENAME=""
              if [ -n "${SRC0_RAW:-}" ] && ! echo "$SRC0_RAW" | grep -qE "^[a-zA-Z]+://"; then
                TAR_BASENAME="$SRC0_RAW"
                TAR_BASENAME="${TAR_BASENAME//%{name}/$NAME}"
                TAR_BASENAME="${TAR_BASENAME//%{version}/$VERSION}"
                TAR_BASENAME="$(basename "$TAR_BASENAME")"
                # если остались макросы — fallback
                if echo "$TAR_BASENAME" | grep -q "%{" ; then
                  TAR_BASENAME=""
                fi
              fi
              if [ -z "$TAR_BASENAME" ]; then
                TAR_BASENAME="${NAME}-${VERSION}.tar.gz"
              fi

              echo "NAME=$NAME"
              echo "VERSION=$VERSION"
              echo "TAR_BASENAME=$TAR_BASENAME"

              # Source tarball из текущего коммита
              git archive --format=tar.gz --prefix="${NAME}-${VERSION}/" \
                -o "$TOPDIR/SOURCES/$TAR_BASENAME" HEAD

              cp -v "$SPEC" "$TOPDIR/SPECS/"
              ls -lah "$TOPDIR/SOURCES" "$TOPDIR/SPECS"

              SPEC_FILE="$(basename "$SPEC")"
              rpmbuild --define "_topdir $TOPDIR" -ba "$TOPDIR/SPECS/$SPEC_FILE"

              mkdir -p /work/'"$ARTIFACT_DIR"'/altlinux
              find "$TOPDIR" -type f \( -name "*.rpm" -o -name "*.src.rpm" \) -print -exec cp -v {} /work/'"$ARTIFACT_DIR"'/altlinux/ \;

              echo "== Collected =="
              ls -lah /work/'"$ARTIFACT_DIR"'/altlinux

              # FAIL если ничего не собралось
              if ! ls /work/'"$ARTIFACT_DIR"'/altlinux/*.rpm >/dev/null 2>&1 && \
                 ! ls /work/'"$ARTIFACT_DIR"'/altlinux/*.src.rpm >/dev/null 2>&1; then
                echo "ERROR: RPM not produced. Nothing to upload." >&2
                exit 1
              fi
            '

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: altlinux-rpm
          path: artifacts/altlinux/*
          if-no-files-found: error
          retention-days: 30
