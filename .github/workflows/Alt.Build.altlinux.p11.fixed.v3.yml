name: AltLinux P11 - RPM

on:
  workflow_dispatch:
    inputs:
      spec_path:
        description: "Optional path to spec (.spec or .spec.example). Example: packaging/orions-gate.spec.example"
        required: false
        default: ""
  push:
    branches: [ main, master ]
    tags: [ "v*" ]
  pull_request:

permissions:
  contents: read

env:
  ARTIFACT_DIR: artifacts

jobs:
  altlinux_rpm:
    name: AltLinux P11 - RPM (rpmbuild, non-root)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Do NOT run the whole job inside alt:p11 container:
      # GitHub Actions JS-based actions require glibc libs that are missing in alt:p11 (libpthread.so.0 error).
      - name: Build RPM inside AltLinux P11 container
        shell: bash
        env:
          SPEC_INPUT: ${{ inputs.spec_path }}
        run: |
          set -euo pipefail

          docker pull alt:p11

          # IMPORTANT: -i is required so heredoc reaches bash -s inside container
          docker run --rm -i \
            -v "$GITHUB_WORKSPACE:/work" \
            -w /work \
            -e SPEC_INPUT="${SPEC_INPUT:-}" \
            -e ARTIFACT_DIR="${ARTIFACT_DIR}" \
            alt:p11 \
            bash --noprofile --norc -s <<'BASH'
          set -euo pipefail

          echo "=== AltLinux container ==="
          cat /etc/*release || true


          apt-get update

          # Base tooling (ALT apt-get doesn't support --no-install-recommends)
          apt-get install -y \
            rpm rpm-build rpmspec \
            git tar gzip xz bzip2 \
            make gcc gcc-c++ \
            findutils coreutils which \
            gawk sed grep \
            ca-certificates curl rsync patch \
            python3-base \
            shadow-utils \
            util-linux

          # Node toolchain (some specs build JS inside %build)
          apt-get install -y node npm || true

          # Git safety (Git 2.35+): repo is mounted from host, mark as safe
          git config --global --add safe.directory /work

          # --- Detect spec (prefer input, then *.spec, then *.spec.example) ---
          SPEC_PATH=""
          if [ -n "${SPEC_INPUT:-}" ]; then
            if [ -f "/work/${SPEC_INPUT#./}" ]; then
              SPEC_PATH="/work/${SPEC_INPUT#./}"
            else
              echo "ERROR: inputs.spec_path not found: ${SPEC_INPUT}" >&2
              exit 1
            fi
          else
            SPEC_PATH="$(cd /work && (git ls-files | grep -iE '\.spec$' | head -n1 || true))"
            if [ -z "$SPEC_PATH" ]; then
              SPEC_PATH="$(cd /work && (git ls-files | grep -iE '\.spec\.example$' | head -n1 || true))"
            fi
            if [ -z "$SPEC_PATH" ]; then
              SPEC_PATH="$(cd /work && (find . -type f \( -iname '*.spec' -o -iname '*.spec.example' \) 2>/dev/null | head -n1 || true))"
              SPEC_PATH="${SPEC_PATH#./}"
            fi
            if [ -n "$SPEC_PATH" ]; then
              SPEC_PATH="/work/${SPEC_PATH#./}"
            fi
          fi

          if [ -z "$SPEC_PATH" ] || [ ! -f "$SPEC_PATH" ]; then
            echo "ERROR: No .spec / .spec.example found in repository. Add it or pass inputs.spec_path." >&2
            exit 1
          fi

          echo "Using spec: $SPEC_PATH"

          # --- Create a non-root user (ALT policy: root can't build RPMs) ---
          # Use /work ownership when possible; otherwise fall back to 1000:1000.
          WORK_UID="$(stat -c '%u' /work 2>/dev/null || echo 1000)"
          WORK_GID="$(stat -c '%g' /work 2>/dev/null || echo 1000)"
          if [ "$WORK_UID" = "0" ]; then WORK_UID=1000; fi
          if [ "$WORK_GID" = "0" ]; then WORK_GID=1000; fi

          if ! getent group "$WORK_GID" >/dev/null 2>&1; then
            groupadd -g "$WORK_GID" buildergrp || true
          fi
          GROUP_NAME="$(getent group "$WORK_GID" | cut -d: -f1 | head -n1 || true)"
          if [ -z "$GROUP_NAME" ]; then GROUP_NAME="buildergrp"; fi

          if ! id -u builder >/dev/null 2>&1; then
            useradd -m -u "$WORK_UID" -g "$WORK_GID" builder || useradd -m builder
          fi

          # Make artifacts dir writable
          mkdir -p "/work/${ARTIFACT_DIR}/altlinux"
          chmod -R a+rwx "/work/${ARTIFACT_DIR}" || true

          # --- rpmbuild tree in builder home ---
          TOPDIR="/home/builder/rpmbuild"
          mkdir -p "$TOPDIR"/{BUILD,BUILDROOT,RPMS,SRPMS,SOURCES,SPECS}
          chown -R builder:"$GROUP_NAME" /home/builder || true

          # Copy/rename spec into builder TOPDIR
          SPEC_BASE="$(basename "$SPEC_PATH")"
          if echo "$SPEC_BASE" | grep -qi '\.spec\.example$'; then
            SPEC_REAL="$TOPDIR/SPECS/${SPEC_BASE%.example}"
          else
            SPEC_REAL="$TOPDIR/SPECS/$SPEC_BASE"
          fi
          cp -v "$SPEC_PATH" "$SPEC_REAL"
          chown builder:"$GROUP_NAME" "$SPEC_REAL" || true

          # --- Patch spec copy for repo differences in alt:p11 ---
          # 1) Drop BuildRequires(pre) that don't exist in p11 mirror
          if grep -qiE '^[[:space:]]*BuildRequires\([[:space:]]*pre[[:space:]]*\):[[:space:]]*rpm-build-electron([[:space:]]|$)' "$SPEC_REAL"; then
            if ! apt-cache show rpm-build-electron >/dev/null 2>&1; then
              echo "WARN: rpm-build-electron not found -> removing BuildRequires(pre): rpm-build-electron"
              sed -i -E '/^[[:space:]]*BuildRequires\([[:space:]]*pre[[:space:]]*\):[[:space:]]*rpm-build-electron([[:space:]]|$)/Id' "$SPEC_REAL"
            fi
          fi
          if grep -qiE '^[[:space:]]*BuildRequires\([[:space:]]*pre[[:space:]]*\):[[:space:]]*rpm-build-nodejs([[:space:]]|$)' "$SPEC_REAL"; then
            if ! apt-cache show rpm-build-nodejs >/dev/null 2>&1; then
              echo "WARN: rpm-build-nodejs not found -> removing BuildRequires(pre): rpm-build-nodejs"
              sed -i -E '/^[[:space:]]*BuildRequires\([[:space:]]*pre[[:space:]]*\):[[:space:]]*rpm-build-nodejs([[:space:]]|$)/Id' "$SPEC_REAL"
            fi
          fi

          # 2) Replace naming mismatches (ALT p11)
          if grep -qiE '^[[:space:]]*BuildRequires:[[:space:]]*nodejs-npm([[:space:]]|$)' "$SPEC_REAL"; then
            if ! apt-cache show nodejs-npm >/dev/null 2>&1; then
              echo "WARN: nodejs-npm not found -> replacing with npm"
              sed -i -E 's/^[[:space:]]*BuildRequires:[[:space:]]*nodejs-npm([[:space:]]|$)/BuildRequires:  npm/Ig' "$SPEC_REAL"
            fi
          fi
          if grep -qiE '^[[:space:]]*BuildRequires:[[:space:]]*git-core([[:space:]]|$)' "$SPEC_REAL"; then
            if ! apt-cache show git-core >/dev/null 2>&1; then
              echo "WARN: git-core not found -> replacing with git"
              sed -i -E 's/^[[:space:]]*BuildRequires:[[:space:]]*git-core([[:space:]]|$)/BuildRequires:  git/Ig' "$SPEC_REAL"
            fi
          fi

          # --- Install BuildRequires from patched spec (as root) ---
          echo "== Installing BuildRequires from spec =="
          REQS="$(
            awk 'BEGIN{IGNORECASE=1}
              /^[[:space:]]*BuildRequires/{
                sub(/^[^:]*:[[:space:]]*/, "", $0);
                gsub(/,/, " ", $0);
                print $0
              }' "$SPEC_REAL" \
            | tr " \t" "\n" \
            | sed -E 's/[[:space:]]+//g' \
            | grep -Ev '^(>=|<=|=|>|<)$' \
            | grep -Ev '^[0-9]+' \
            | grep -Ev '^%\\{' \
            | sort -u
          )"

          if [ -n "$REQS" ]; then
            # shellcheck disable=SC2086
            for pkg in $REQS; do
              case "$pkg" in
                nodejs-npm) pkg2="npm" ;;
                git-core) pkg2="git" ;;
                *) pkg2="$pkg" ;;
              esac
              echo "  -> $pkg (install: $pkg2)"
              if apt-cache show "$pkg2" >/dev/null 2>&1; then
                apt-get install -y "$pkg2"
              else
                echo "ERROR: BuildRequires package not found in repos: $pkg2 (from $pkg)" >&2
                echo "apt-cache search '$pkg2' (top 50):" >&2
                apt-cache search "$pkg2" | head -n 50 || true
                exit 1
              fi
            done
          fi

          # --- Parse Name/Version and ensure Source0/1/2 in SOURCES ---
          NAME="$(awk -F': *' 'tolower($1)=="name" {print $2; exit}' "$SPEC_REAL" | tr -d "\r")"
          VERSION="$(awk -F': *' 'tolower($1)=="version" {print $2; exit}' "$SPEC_REAL" | tr -d "\r")"
          SRC0_RAW="$(awk -F': *' 'tolower($1)=="source0" {print $2; exit}' "$SPEC_REAL" | tr -d "\r" || true)"
          SRC1_RAW="$(awk -F': *' 'tolower($1)=="source1" {print $2; exit}' "$SPEC_REAL" | tr -d "\r" || true)"
          SRC2_RAW="$(awk -F': *' 'tolower($1)=="source2" {print $2; exit}' "$SPEC_REAL" | tr -d "\r" || true)"

          if [ -z "${NAME:-}" ] || [ -z "${VERSION:-}" ]; then
            echo "ERROR: Cannot parse Name/Version from spec" >&2
            head -n 80 "$SPEC_REAL" || true
            exit 1
          fi

          # Source0 filename must match what rpmbuild will look for after macro expansion.
          # Expand %{name}/%{version} and then validate we got a sane tarball name.
          TAR_BASENAME="${NAME}-${VERSION}.tar.gz"
          if [ -n "${SRC0_RAW:-}" ] && ! echo "$SRC0_RAW" | grep -qE '^[a-zA-Z]+://'; then
            tmp="$(printf '%s' "$SRC0_RAW" | sed -e "s/%{name}/${NAME}/g" -e "s/%{version}/${VERSION}/g" | tr -d '\r')"
            tmp="$(basename "$tmp")"
            # Defensive: strip stray trailing braces that sometimes sneak in
            while [ "${tmp: -1}" = "}" ]; do tmp="${tmp%}"; done

            case "$tmp" in
              *.tar.gz|*.tgz|*.tar.xz|*.tar.bz2|*.tar)
                TAR_BASENAME="$tmp"
                ;;
              *)
                echo "WARN: Source0 after expansion looks suspicious: '$tmp' — using default '${NAME}-${VERSION}.tar.gz'"
                ;;
            esac
          fi

          echo "Name=$NAME"
          echo "Version=$VERSION"
          echo "Source0=$TAR_BASENAME"
          echo "Source1(raw)=$SRC1_RAW"
          echo "Source2(raw)=$SRC2_RAW"

          echo "== Create Source0 tarball from current commit =="
          SRC_TMP="$(mktemp -d)"
          mkdir -p "$SRC_TMP/${NAME}-${VERSION}"
          # Copy working tree to a versioned top-level directory (exclude VCS + CI outputs)
          rsync -a --delete \
            --exclude='.git' \
            --exclude="${ARTIFACT_DIR}" \
            --exclude='rpmbuild' \
            /work/ "$SRC_TMP/${NAME}-${VERSION}/"

          tar -C "$SRC_TMP" -czf "$TOPDIR/SOURCES/$TAR_BASENAME" "${NAME}-${VERSION}"
          rm -rf "$SRC_TMP"

          if [ ! -f "$TOPDIR/SOURCES/$TAR_BASENAME" ]; then
            echo "ERROR: Source0 tarball was not created: $TOPDIR/SOURCES/$TAR_BASENAME" >&2
            echo "Debug: ls -lah $TOPDIR/SOURCES" >&2
            ls -lah "$TOPDIR/SOURCES" || true
            echo "Debug: ls -lah /work" >&2
            ls -lah /work | head -n 200 || true
            exit 1
          fi
          ls -lah "$TOPDIR/SOURCES/$TAR_BASENAME"

          echo "== Provide Source1/Source2 if needed =="
          # For your spec: Source1=%{name}.desktop, Source2=%{name}.png
          if [ -n "${SRC1_RAW:-}" ]; then
            DESKTOP_NAME="${NAME}.desktop"
            if [ -f "/work/$DESKTOP_NAME" ]; then
              cp -v "/work/$DESKTOP_NAME" "$TOPDIR/SOURCES/$DESKTOP_NAME"
            else
              echo "Generating $DESKTOP_NAME"
              printf '%s\n' \
                '[Desktop Entry]' \
                'Type=Application' \
                "Name=Orion's Gate" \
                "Name[ru]=Orion's Gate" \
                'Comment=Video overlay and subtitle system' \
                'Comment[ru]=Система видео-оверлея и субтитров' \
                "Exec=${NAME} %U" \
                "Icon=${NAME}" \
                'Terminal=false' \
                'Categories=Video;AudioVideo;' \
                'StartupNotify=true' \
                > "$TOPDIR/SOURCES/$DESKTOP_NAME"
            fi
          fi

          if [ -n "${SRC2_RAW:-}" ]; then
            ICON_NAME="${NAME}.png"
            if [ -f "/work/$ICON_NAME" ]; then
              cp -v "/work/$ICON_NAME" "$TOPDIR/SOURCES/$ICON_NAME"
            elif [ -f "/work/resources/icon_512.png" ]; then
              cp -v "/work/resources/icon_512.png" "$TOPDIR/SOURCES/$ICON_NAME"
            elif [ -f "/work/resources/icon.png" ]; then
              cp -v "/work/resources/icon.png" "$TOPDIR/SOURCES/$ICON_NAME"
            else
              echo "WARN: Icon source not found. Creating 1x1 placeholder (may be rejected by packaging policy)."
              printf '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x01\x00\x00\x00\x01\x08\x06\x00\x00\x00\x1f\x15\xc4\x89\x00\x00\x00\nIDATx\x9cc\x00\x01\x00\x00\x05\x00\x01\r\n-\xb4\x00\x00\x00\x00IEND\xaeB`\x82' > "$TOPDIR/SOURCES/$ICON_NAME"
            fi
          fi

          chown -R builder:"$GROUP_NAME" "$TOPDIR" || true

          echo "== Build RPM as non-root (ALT policy) =="
          # Create a tiny script to avoid quoting issues
          BUILD_SH="/tmp/run-rpmbuild.sh"
          printf '%s\n' \
            '#!/bin/bash' \
            'set -euo pipefail' \
            'git config --global --add safe.directory /work' \
            "rpmbuild --define \"_topdir ${TOPDIR}\" -ba \"${SPEC_REAL}\"" \
            > "$BUILD_SH"
          chmod +x "$BUILD_SH"
          chown builder:"$GROUP_NAME" "$BUILD_SH" || true

          if command -v runuser >/dev/null 2>&1; then
            runuser -u builder -- "$BUILD_SH"
          elif command -v su >/dev/null 2>&1; then
            su -s /bin/bash builder -c "$BUILD_SH"
          else
            echo "ERROR: Neither runuser nor su found in container. Install util-linux or shadow packages." >&2
            echo "Debug: ls /bin /usr/bin | grep -E '^(su|runuser)$' || true" >&2
            ls -lah /bin /usr/bin | grep -E '/(su|runuser)$' || true
            exit 1
          fi

          echo "== Collect RPMs =="
          find "$TOPDIR" -type f \( -name "*.rpm" -o -name "*.src.rpm" \) -print -exec cp -v {} "/work/${ARTIFACT_DIR}/altlinux/" \; || true

          echo "== Collected =="
          ls -lah "/work/${ARTIFACT_DIR}/altlinux" || true

          if ! ls "/work/${ARTIFACT_DIR}/altlinux/"*.rpm >/dev/null 2>&1 && \
             ! ls "/work/${ARTIFACT_DIR}/altlinux/"*.src.rpm >/dev/null 2>&1; then
            echo "ERROR: RPM not produced. Nothing to upload." >&2
            exit 1
          fi
          BASH

      - name: Upload artifacts (AltLinux RPM)
        uses: actions/upload-artifact@v4
        with:
          name: altlinux-rpm
          path: ${{ env.ARTIFACT_DIR }}/altlinux/**
          if-no-files-found: error
          retention-days: 30