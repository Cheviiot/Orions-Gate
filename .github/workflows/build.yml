name: Build Release Artifacts

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

env:
  ARTIFACT_DIR: artifacts

jobs:
  ubuntu_deb_appimage:
    name: Ubuntu - deb & AppImage & RPM
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libx11-dev libxext-dev libxkbfile-dev libappindicator3-dev fonts-liberation xdg-utils imagemagick xvfb

      - name: Install project dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Build
        run: npm run build

      - name: Executable diagnostics (ldd)
        run: |
          echo "Searching for executable ELF files and checking ldd for libcrypt"
          set -euo pipefail
          OUT=/tmp/executables.txt
          : > "$OUT"

          # Search common locations: workspace executables, electron-builder cache, release
          find . -path './node_modules' -prune -o -type f -executable -print >>"$OUT" || true
          if [ -d "$HOME/.cache/electron-builder" ]; then
            find "$HOME/.cache/electron-builder" -type f -executable -print >>"$OUT" || true
          fi
          if [ -d "release" ]; then
            find release -type f -executable -print >>"$OUT" || true
          fi

          sort -u "$OUT" -o "$OUT" || true

          if [ ! -s "$OUT" ]; then
            echo "No executables found to inspect"
            exit 0
          fi

          echo "Executables found:";
          cat "$OUT"

          while IFS= read -r f; do
            echo "---- $f ----"
            file "$f" || true
            ldd "$f" 2>&1 | sed -n '1,200p' || true
          done < "$OUT"

          # Also explicitly look for any file named 'fpm' and ldd it
          if find . -type f -name 'fpm' -print -quit >/dev/null 2>&1; then
            echo "Found fpm files:"; find . -type f -name 'fpm' -print
            find . -type f -name 'fpm' -exec sh -c 'echo "---- {} ----"; file "{}"; ldd "{}" 2>&1 || true' \; || true
          fi

      - name: Install packaging tools for RPM
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ruby rpm dpkg-dev xz-utils fakeroot imagemagick || true

      - name: Package deb, AppImage & RPM
        run: |
          # try project-provided scripts first, fallback to electron-builder
          npm run make:deb || npx electron-builder --linux deb --config electron-builder.yml
          npm run make:appimage || npx electron-builder --linux AppImage --config electron-builder.yml
          npm run make:rpm || npx electron-builder --linux rpm --x64 --config electron-builder.yml || true

      - name: Collect artifacts
        run: |
          mkdir -p $ARTIFACT_DIR/ubuntu
          # copy deb, AppImage, rpm into ubuntu artifact dir
          shopt -s nullglob || true
          cp -v release/*.{deb,AppImage,rpm} $ARTIFACT_DIR/ubuntu/ 2>/dev/null || true
          # also copy any installers from release root
          cp -v release/* $ARTIFACT_DIR/ubuntu/ 2>/dev/null || true
          ls -lah $ARTIFACT_DIR || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-deb-appimage
          path: ${{ env.ARTIFACT_DIR }}/ubuntu/**
          retention-days: 30

  altlinux_rpm:
    name: AltLinux P11 - RPM (use existing script)
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            rpm dpkg-dev rpm2cpio build-essential make gcc g++ git xz-utils tar gzip fakeroot nodejs npm imagemagick \
            ruby ruby-dev rubygems || true
          # Install fpm (used by scripts/build-altlinux.sh)
          sudo gem install --no-document fpm || true

      - name: Locate .spec file
        id: findspec
        run: |
          set -euo pipefail
          SPEC_PATH=$(find . -maxdepth 4 -type f -name "*.spec" | head -n1 || true)
          if [ -z "$SPEC_PATH" ]; then
            echo "No .spec file found in repository. Will fallback to scripts/build-altlinux.sh" >&2
            echo "spec=" >> $GITHUB_OUTPUT
          else
            echo "spec=$SPEC_PATH" >> $GITHUB_OUTPUT
          fi

      - name: Prepare rpmbuild tree
        run: |
          echo "%_topdir $HOME/rpmbuild" > ~/.rpmmacros
          mkdir -p ~/rpmbuild/SOURCES ~/rpmbuild/SPECS ~/rpmbuild/BUILD || true

      - name: Create source tarball from current commit
        if: steps.findspec.outputs.spec != ''
        run: |
          set -euo pipefail
          FULL_VERSION=$(node -p "require('./package.json').version")
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(echo "$FULL_VERSION" | sed 's/-.*$//')
          TAR_NAME=${PKG_NAME}-${PKG_VERSION}.tar.gz
          git archive --format=tar.gz --prefix=${PKG_NAME}-${PKG_VERSION}/ -o ~/rpmbuild/SOURCES/${TAR_NAME} HEAD

      - name: Copy spec into SPECS
        if: steps.findspec.outputs.spec != ''
        run: |
          set -euo pipefail
          SPEC_PATH=${{ steps.findspec.outputs.spec }}
          cp "$SPEC_PATH" ~/rpmbuild/SPECS/

      - name: Install npm deps and build (for rpm sources)
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          npm run build

      - name: Build RPM via rpmbuild
        if: steps.findspec.outputs.spec != ''
        run: |
          set -xuo pipefail
          SPEC_FILE=$(basename "${{ steps.findspec.outputs.spec }}")
          rpmbuild --define "_topdir $HOME/rpmbuild" -ba ~/rpmbuild/SPECS/${SPEC_FILE}

      - name: AltLinux diagnostics
        if: steps.findspec.outputs.spec == ''
        run: |
          echo "WHOAMI: $(whoami)" || true
          echo "PWD: $(pwd)" || true
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE" || true
          ls -lah . || true

      - name: Fallback - run scripts/build-altlinux.sh as builder
        if: steps.findspec.outputs.spec == ''
        run: |
          set -euo pipefail
          echo "Running AltLinux fallback script as current user (avoid sudo/chown issues)"
          cd "$GITHUB_WORKSPACE"
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          npm run build
          bash scripts/build-altlinux.sh

      - name: Collect AltLinux RPMs
        run: |
          set -euo pipefail
          ART_DIR="${{ env.ARTIFACT_DIR }}"
          mkdir -p "$ART_DIR/altlinux"

          # Collect from rpmbuild (if present)
          if [ -d "$HOME/rpmbuild" ]; then
            find "$HOME/rpmbuild" -type f -name '*.rpm' -print0 | xargs -0 -I{} cp -v {} "$ART_DIR/altlinux/" || true
            find "$HOME/rpmbuild" -type f -name '*.src.rpm' -print0 | xargs -0 -I{} cp -v {} "$ART_DIR/altlinux/" || true
          fi

          # Also collect any RPMs produced in release/
          if [ -d "release" ]; then
            find release -type f -name '*.rpm' -print0 | xargs -0 -I{} cp -v {} "$ART_DIR/altlinux/" || true
          fi

          echo "Artifacts in $ART_DIR/altlinux:" 
          ls -lah "$ART_DIR/altlinux" || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: altlinux-rpm
          path: ${{ env.ARTIFACT_DIR }}/altlinux/**
          retention-days: 30

  windows_exe_msi:
    name: Windows - exe & msi
    runs-on: windows-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package.json

      - name: Install project dependencies
        run: |
          if (Test-Path package-lock.json) { npm ci } else { npm install }

      - name: Build
        run: npm run build

      - name: Package Windows installers
        run: |
          npx electron-builder --win nsis msi --config electron-builder.yml || true

      - name: Collect Windows artifacts
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path $env:ARTIFACT_DIR\windows | Out-Null
          Copy-Item -Path release\* -Destination $env:ARTIFACT_DIR\windows -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path $env:ARTIFACT_DIR\windows -Recurse | Select-Object FullName,Length

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe-msi
          path: ${{ env.ARTIFACT_DIR }}/windows/**
          retention-days: 30

  create_release:
    name: Create GitHub Release (on tag)
    needs: [ubuntu_deb_appimage, altlinux_rpm, windows_exe_msi]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            downloaded-artifacts/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
