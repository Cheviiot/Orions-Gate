name: Build Release Artifacts

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

env:
  ARTIFACT_DIR: artifacts

jobs:
  ubuntu_deb_appimage:
    name: Ubuntu - deb & AppImage
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libx11-dev libxext-dev libxkbfile-dev libappindicator3-dev fonts-liberation xdg-utils imagemagick xvfb

      - name: Install project dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Build
        run: npm run build

      - name: Package deb & AppImage
        run: |
          npm run make:deb || npx electron-builder --linux deb --config electron-builder.yml
          npm run make:appimage || npx electron-builder --linux AppImage --config electron-builder.yml

      - name: Collect artifacts
        run: |
          mkdir -p $ARTIFACT_DIR/ubuntu
          cp -v release/*.{deb,AppImage} $ARTIFACT_DIR/ubuntu/ || true
          ls -lah $ARTIFACT_DIR || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-deb-appimage
          path: ${{ env.ARTIFACT_DIR }}/ubuntu/**
          retention-days: 30

  fedora_rpm:
    name: Fedora - RPM
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system deps (dnf)
        run: |
          sudo dnf -y update
          sudo dnf install -y --setopt=install_weak_deps=False nodejs npm rpmdevtools gcc-c++ make python3 xz ImageMagick || true

      - name: Install project dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Build
        run: npm run build

      - name: Package RPM (electron-builder)
        run: |
          mkdir -p $ARTIFACT_DIR/fedora
          npx electron-builder --linux rpm --x64 --config electron-builder.yml || true
          cp -v release/*.rpm $ARTIFACT_DIR/fedora/ || true
          ls -lah $ARTIFACT_DIR || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fedora-rpm
          path: ${{ env.ARTIFACT_DIR }}/fedora/**
          retention-days: 30

  altlinux_rpm:
    name: AltLinux P11 - RPM (use existing script)
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            rpm dpkg-dev rpm2cpio rpm-build rpmdevtools build-essential make gcc g++ git xz-utils tar gzip fakeroot nodejs npm imagemagick || true

      - name: Locate .spec file
        id: findspec
        run: |
          set -euo pipefail
          SPEC_PATH=$(find . -maxdepth 4 -type f -name "*.spec" | head -n1 || true)
          if [ -z "$SPEC_PATH" ]; then
            echo "No .spec file found in repository. Will fallback to scripts/build-altlinux.sh" >&2
            echo "spec=" >> $GITHUB_OUTPUT
          else
            echo "spec=$SPEC_PATH" >> $GITHUB_OUTPUT
          fi

      - name: Prepare rpmbuild tree
        run: |
          rpmdev-setuptree || true
          echo "%_topdir $HOME/rpmbuild" > ~/.rpmmacros
          mkdir -p ~/rpmbuild/SOURCES ~/rpmbuild/SPECS ~/rpmbuild/BUILD

      - name: Create source tarball from current commit
        if: steps.findspec.outputs.spec != ''
        run: |
          set -euo pipefail
          FULL_VERSION=$(node -p "require('./package.json').version")
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(echo "$FULL_VERSION" | sed 's/-.*$//')
          TAR_NAME=${PKG_NAME}-${PKG_VERSION}.tar.gz
          git archive --format=tar.gz --prefix=${PKG_NAME}-${PKG_VERSION}/ -o ~/rpmbuild/SOURCES/${TAR_NAME} HEAD

      - name: Copy spec into SPECS
        if: steps.findspec.outputs.spec != ''
        run: |
          set -euo pipefail
          SPEC_PATH=${{ steps.findspec.outputs.spec }}
          cp "$SPEC_PATH" ~/rpmbuild/SPECS/

      - name: Install npm deps and build (for rpm sources)
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          npm run build

      - name: Build RPM via rpmbuild
        if: steps.findspec.outputs.spec != ''
        run: |
          set -xuo pipefail
          SPEC_FILE=$(basename "${{ steps.findspec.outputs.spec }}")
          rpmbuild --define "_topdir $HOME/rpmbuild" -ba ~/rpmbuild/SPECS/${SPEC_FILE}

      - name: Fallback - run scripts/build-altlinux.sh as builder
        if: steps.findspec.outputs.spec == ''
        run: |
          set -euo pipefail
          sudo useradd -m builder || true
          sudo chown -R builder:builder $PWD || true
          echo "builder ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/builder > /dev/null
          sudo chmod 0440 /etc/sudoers.d/builder
          sudo -u builder bash -lc 'if [ -f package-lock.json ]; then npm ci; else npm install; fi && npm run build'
          sudo -u builder bash -lc 'bash scripts/build-altlinux.sh'

      - name: Collect AltLinux RPMs
        run: |
          mkdir -p $ARTIFACT_DIR/altlinux
          cp -v ~/rpmbuild/RPMS/**/*.rpm $ARTIFACT_DIR/altlinux/ 2>/dev/null || true
          cp -v ~/rpmbuild/SRPMS/*.src.rpm $ARTIFACT_DIR/altlinux/ 2>/dev/null || true
          ls -lah $ARTIFACT_DIR || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: altlinux-rpm
          path: ${{ env.ARTIFACT_DIR }}/altlinux/**
          retention-days: 30

  windows_exe_msi:
    name: Windows - exe & msi
    runs-on: windows-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package.json

      - name: Install project dependencies
        run: |
          if (Test-Path package-lock.json) { npm ci } else { npm install }

      - name: Build
        run: npm run build

      - name: Package Windows installers
        run: |
          npx electron-builder --win nsis msi --config electron-builder.yml || true

      - name: Collect Windows artifacts
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path $env:ARTIFACT_DIR\windows | Out-Null
          Copy-Item -Path release\* -Destination $env:ARTIFACT_DIR\windows -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path $env:ARTIFACT_DIR\windows -Recurse | Select-Object FullName,Length

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe-msi
          path: ${{ env.ARTIFACT_DIR }}/windows/**
          retention-days: 30

  create_release:
    name: Create GitHub Release (on tag)
    needs: [ubuntu_deb_appimage, fedora_rpm, altlinux_rpm, windows_exe_msi]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            downloaded-artifacts/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
