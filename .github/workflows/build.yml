name: Build Release Artifacts

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

env:
  ARTIFACT_DIR: artifacts

jobs:
  ubuntu_deb_appimage:
    name: Ubuntu - deb & AppImage
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libx11-dev libxext-dev libxkbfile-dev libappindicator3-dev fonts-liberation xdg-utils imagemagick xvfb

      - name: Install project dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Build
        run: npm run build

      - name: Executable diagnostics (ldd)
        run: |
          echo "Searching for executable ELF files and checking ldd for libcrypt"
          set -euo pipefail
          OUT=/tmp/executables.txt
          : > "$OUT"

          # Search common locations: workspace executables, electron-builder cache, release
          find . -path './node_modules' -prune -o -type f -executable -print >>"$OUT" || true
          if [ -d "$HOME/.cache/electron-builder" ]; then
            find "$HOME/.cache/electron-builder" -type f -executable -print >>"$OUT" || true
          fi
          if [ -d "release" ]; then
            find release -type f -executable -print >>"$OUT" || true
          fi

          sort -u "$OUT" -o "$OUT" || true

          if [ ! -s "$OUT" ]; then
            echo "No executables found to inspect"
            exit 0
          fi

          echo "Executables found:";
          cat "$OUT"

          while IFS= read -r f; do
            echo "---- $f ----"
            file "$f" || true
            ldd "$f" 2>&1 | sed -n '1,200p' || true
          done < "$OUT"

          # Also explicitly look for any file named 'fpm' and ldd it
          if find . -type f -name 'fpm' -print -quit >/dev/null 2>&1; then
            echo "Found fpm files:"; find . -type f -name 'fpm' -print
            find . -type f -name 'fpm' -exec sh -c 'echo "---- {} ----"; file "{}"; ldd "{}" 2>&1 || true' \; || true
          fi

      - name: Package deb & AppImage
        run: |
          npm run make:deb || npx electron-builder --linux deb --config electron-builder.yml
          npm run make:appimage || npx electron-builder --linux AppImage --config electron-builder.yml

      - name: Collect artifacts
        run: |
          mkdir -p $ARTIFACT_DIR/ubuntu
          cp -v release/*.{deb,AppImage} $ARTIFACT_DIR/ubuntu/ || true
          ls -lah $ARTIFACT_DIR || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-deb-appimage
          path: ${{ env.ARTIFACT_DIR }}/ubuntu/**
          retention-days: 30

  fedora_rpm:
    name: Fedora - RPM
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system deps (dnf)
        run: |
          dnf -y update || true
          # ensure libcrypt (libcrypt.so.1) is available for bundled fpm ruby
          dnf install -y --setopt=install_weak_deps=False nodejs npm rpmdevtools gcc-c++ make python3 xz ImageMagick libxcrypt libxcrypt-compat || true

      - name: DNF diagnostics
        run: |
          echo "WHOAMI: $(whoami)"
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "ARTIFACT_DIR=$ARTIFACT_DIR"
          echo "Which dnf:"; which dnf || true
          echo "dnf version:"; dnf --version || true
          echo "rpm version:"; rpm --version || true
          echo "node version:"; node -v || true
          echo "npm version:"; npm -v || true
          echo "Listing / and workspace root:"; ls -lah / || true; ls -lah $GITHUB_WORKSPACE || true

      - name: Install project dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Build
        run: npm run build

      - name: Package RPM (electron-builder)
        run: |
          mkdir -p $ARTIFACT_DIR/fedora
          npx electron-builder --linux rpm --x64 --config electron-builder.yml || true
          # try to copy artifacts (may be empty if builder placed them elsewhere)
          cp -v release/*.rpm $ARTIFACT_DIR/fedora/ || true
          ls -lah $ARTIFACT_DIR || true

      - name: Debug - show release and workspace
        run: |
          echo "PWD=$(pwd)"
          echo "Listing workspace root:"
          ls -lah . || true
          echo "Listing release/:"
          ls -lah release || true
          echo "Find files under release/:"
          find release -maxdepth 4 -type f -print || true
          echo "List any rpms in entire workspace:" 
          find . -type f -name "*.rpm" -print || true

      - name: Collect Fedora RPMs
        shell: bash
        run: |
          set -euo pipefail
          ART_DIR="${{ env.ARTIFACT_DIR }}"
          mkdir -p "$ART_DIR/fedora"

          # Find RPMs in workspace excluding node_modules
          find . -path './node_modules' -prune -o -type f -name '*.rpm' -print > /tmp/workspace-rpms.txt || true

          # Also check $HOME/rpmbuild if present
          if [ -d "$HOME/rpmbuild" ]; then
            find "$HOME/rpmbuild" -type f -name '*.rpm' -print >> /tmp/workspace-rpms.txt || true
          fi

          # Normalize (remove empty lines) and unique
          awk 'NF' /tmp/workspace-rpms.txt | sort -u > /tmp/found-rpms.txt || true

          if [ ! -s /tmp/found-rpms.txt ]; then
            echo "ERROR: no RPM files found in workspace or $HOME/rpmbuild"
            echo "--- Workspace top-level ---"
            ls -lah . || true
            echo "--- release/ ---"
            ls -lah release || true
            if [ -d "$HOME/rpmbuild" ]; then
              echo "--- $HOME/rpmbuild ---"
              ls -lah "$HOME/rpmbuild" || true
            fi
            echo "Full find under workspace (for debugging):"
            find . -type f -print || true
            exit 1
          fi

          echo "Found RPMs:" 
          cat /tmp/found-rpms.txt

          while IFS= read -r f; do
            echo "Copying: $f -> $ART_DIR/fedora/"
            cp -v "$f" "$ART_DIR/fedora/" || true
          done < /tmp/found-rpms.txt

          echo "Artifacts in $ART_DIR/fedora:" 
          ls -lah "$ART_DIR/fedora" || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fedora-rpm
          path: ${{ env.ARTIFACT_DIR }}/fedora/*.rpm
          if-no-files-found: error
          retention-days: 30

  altlinux_rpm:
    name: AltLinux P11 - RPM (use existing script)
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            rpm dpkg-dev rpm2cpio build-essential make gcc g++ git xz-utils tar gzip fakeroot nodejs npm imagemagick || true

      - name: Locate .spec file
        id: findspec
        run: |
          set -euo pipefail
          SPEC_PATH=$(find . -maxdepth 4 -type f -name "*.spec" | head -n1 || true)
          if [ -z "$SPEC_PATH" ]; then
            echo "No .spec file found in repository. Will fallback to scripts/build-altlinux.sh" >&2
            echo "spec=" >> $GITHUB_OUTPUT
          else
            echo "spec=$SPEC_PATH" >> $GITHUB_OUTPUT
          fi

      - name: Prepare rpmbuild tree
        run: |
          rpmdev-setuptree || true
          echo "%_topdir $HOME/rpmbuild" > ~/.rpmmacros
          mkdir -p ~/rpmbuild/SOURCES ~/rpmbuild/SPECS ~/rpmbuild/BUILD

      - name: Create source tarball from current commit
        if: steps.findspec.outputs.spec != ''
        run: |
          set -euo pipefail
          FULL_VERSION=$(node -p "require('./package.json').version")
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(echo "$FULL_VERSION" | sed 's/-.*$//')
          TAR_NAME=${PKG_NAME}-${PKG_VERSION}.tar.gz
          git archive --format=tar.gz --prefix=${PKG_NAME}-${PKG_VERSION}/ -o ~/rpmbuild/SOURCES/${TAR_NAME} HEAD

      - name: Copy spec into SPECS
        if: steps.findspec.outputs.spec != ''
        run: |
          set -euo pipefail
          SPEC_PATH=${{ steps.findspec.outputs.spec }}
          cp "$SPEC_PATH" ~/rpmbuild/SPECS/

      - name: Install npm deps and build (for rpm sources)
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          npm run build

      - name: Build RPM via rpmbuild
        if: steps.findspec.outputs.spec != ''
        run: |
          set -xuo pipefail
          SPEC_FILE=$(basename "${{ steps.findspec.outputs.spec }}")
          rpmbuild --define "_topdir $HOME/rpmbuild" -ba ~/rpmbuild/SPECS/${SPEC_FILE}

      - name: Fallback - run scripts/build-altlinux.sh as builder
        if: steps.findspec.outputs.spec == ''
        run: |
          set -euo pipefail
          echo "Running AltLinux fallback script as current user (avoid sudo/chown issues)"
          cd "$GITHUB_WORKSPACE"
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          npm run build
          bash scripts/build-altlinux.sh

      - name: Collect AltLinux RPMs
        run: |
          mkdir -p $ARTIFACT_DIR/altlinux
          cp -v ~/rpmbuild/RPMS/**/*.rpm $ARTIFACT_DIR/altlinux/ 2>/dev/null || true
          cp -v ~/rpmbuild/SRPMS/*.src.rpm $ARTIFACT_DIR/altlinux/ 2>/dev/null || true
          ls -lah $ARTIFACT_DIR || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: altlinux-rpm
          path: ${{ env.ARTIFACT_DIR }}/altlinux/**
          retention-days: 30

  windows_exe_msi:
    name: Windows - exe & msi
    runs-on: windows-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package.json

      - name: Install project dependencies
        run: |
          if (Test-Path package-lock.json) { npm ci } else { npm install }

      - name: Build
        run: npm run build

      - name: Package Windows installers
        run: |
          npx electron-builder --win nsis msi --config electron-builder.yml || true

      - name: Collect Windows artifacts
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path $env:ARTIFACT_DIR\windows | Out-Null
          Copy-Item -Path release\* -Destination $env:ARTIFACT_DIR\windows -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path $env:ARTIFACT_DIR\windows -Recurse | Select-Object FullName,Length

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe-msi
          path: ${{ env.ARTIFACT_DIR }}/windows/**
          retention-days: 30

  create_release:
    name: Create GitHub Release (on tag)
    needs: [ubuntu_deb_appimage, fedora_rpm, altlinux_rpm, windows_exe_msi]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            downloaded-artifacts/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
