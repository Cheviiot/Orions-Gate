name: desktop-build

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  linux:
    name: Linux (deb + AppImage)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package.json

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev libxext-dev libxkbfile-dev \
            libappindicator3-dev fonts-liberation \
            xdg-utils imagemagick

      - name: Install project dependencies
        run: |
          npm install
          npm run playwright:install

      - name: Generate icons
        run: npm run generate-icons

      - name: Build application
        run: npm run build

      - name: Package (deb + AppImage)
        run: npx electron-builder --linux deb AppImage --config electron-builder.yml

      - name: Run smoke tests
        run: npm run test:smoke

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: release/**/*
          retention-days: 30

  windows:
    name: Windows (NSIS + MSI)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package.json

      - name: Install project dependencies
        run: |
          npm install
          npm run playwright:install

      - name: Generate icons
        run: npm run generate-icons

      - name: Build application
        run: npm run build

      - name: Package (NSIS + MSI)
        run: npx electron-builder --win nsis msi --config electron-builder.yml

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: release/**/*
          retention-days: 30

  altlinux:
    name: Alt Linux (RPM)
    runs-on: ubuntu-latest
    container:
      image: docker.io/alt:sisyphus
    steps:
      - uses: actions/checkout@v4

      - name: Install base build tools
        run: |
          apt-get update
          apt-get install -y \
            curl ca-certificates git \
            rpm-build rpm-build-nodejs rpmlint \
            python3 make gcc-c++ \
            libX11-devel libXext-devel libxkbfile-devel \
            ImageMagick

      - name: Install Node.js from NodeSource
        run: |
          curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs

      - name: Setup RPM build environment
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cat > ~/.rpmmacros <<EOF
          %_topdir %(echo $HOME)/rpmbuild
          %packager Orion's Gate CI <ci@orionsgate.dev>
          EOF

      - name: Install project dependencies
        run: |
          npm install
          npm run playwright:install || true

      - name: Generate icons
        run: npm run generate-icons

      - name: Build application
        run: npm run build

      - name: Create source tarball
        run: |
          PKG_NAME="orions-gate"
          PKG_VERSION=$(node -p "require('./package.json').version")
          mkdir -p ~/rpmbuild/SOURCES
          tar czf ~/rpmbuild/SOURCES/${PKG_NAME}-${PKG_VERSION}.tar.gz \
            --exclude=node_modules --exclude=.git --exclude=release \
            --transform "s,^,${PKG_NAME}-${PKG_VERSION}/," .

      - name: Create RPM SPEC file
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          cat > ~/rpmbuild/SPECS/orions-gate.spec <<'EOF'
          Name:           orions-gate
          Version:        ${PKG_VERSION}
          Release:        alt1
          Summary:        Transparent proxy web browser with VOT integration
          License:        MIT
          Group:          Networking/WWW
          URL:            https://github.com/Cheviiot/Orions-Gate
          Source0:        %{name}-%{version}.tar.gz

          BuildRequires:  rpm-build-nodejs >= 20
          BuildRequires:  gcc-c++
          BuildRequires:  libX11-devel
          BuildRequires:  libXext-devel
          BuildRequires:  libxkbfile-devel
          BuildRequires:  ImageMagick

          Requires:       libX11
          Requires:       libXext
          Requires:       libxkbfile

          %description
          Orion's Gate is a transparent proxy web browser built on Electron 40,
          designed for secure content access with integrated Voice Over Translation.

          %prep
          %setup -q

          %build
          npm ci --legacy-peer-deps || npm install
          npm run generate-icons
          npm run build
          npx electron-builder --linux rpm --x64

          %install
          mkdir -p %{buildroot}%{_bindir}
          mkdir -p %{buildroot}%{_datadir}/applications
          mkdir -p %{buildroot}%{_datadir}/icons/hicolor

          # Extract from built RPM or install manually
          if [ -f release/*.rpm ]; then
            rpm2cpio release/*.rpm | (cd %{buildroot} && cpio -idmv)
          fi

          %files
          %{_bindir}/%{name}
          %{_datadir}/applications/%{name}.desktop
          %{_datadir}/icons/hicolor/*/apps/%{name}.png

          %changelog
          * $(LANG=C date "+%a %b %d %Y") CI Robot <ci@orionsgate.dev> ${PKG_VERSION}-alt1
          - Automated CI/CD build
          EOF
          
          # Replace version in spec
          sed -i "s/\${PKG_VERSION}/${PKG_VERSION}/g" ~/rpmbuild/SPECS/orions-gate.spec

      - name: Build RPM with rpmbuild
        run: |
          rpmbuild -ba ~/rpmbuild/SPECS/orions-gate.spec

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: altlinux-rpm-artifacts
          path: |
            ~/rpmbuild/RPMS/**/*.rpm
            ~/rpmbuild/SRPMS/*.src.rpm
          retention-days: 30

