name: desktop-build

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  linux:
    name: Linux (deb + AppImage)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package.json

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev libxext-dev libxkbfile-dev \
            libappindicator3-dev fonts-liberation \
            xdg-utils imagemagick

      - name: Install project dependencies
        run: |
          npm install
          npm run playwright:install

      - name: Generate icons
        run: npm run generate-icons

      - name: Build application
        run: npm run build

      - name: Package (deb + AppImage)
        run: npx electron-builder --linux deb AppImage --config electron-builder.yml

      - name: Run smoke tests
        run: npm run test:smoke

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: release/**/*
          retention-days: 30

  linux-rpm:
    name: Linux (RPM)
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y \
            nodejs npm \
            rpm-build rpmdevtools rpmlint \
            gcc-c++ make python3 \
            libX11-devel libXext-devel libxkbfile-devel \
            ImageMagick git glibc-devel

      - name: Install project dependencies
        run: npm install

      - name: Generate icons
        run: npm run generate-icons

      - name: Build application
        run: npm run build

      - name: Setup RPM build environment
        run: |
          rpmdev-setuptree
          echo "%_topdir $HOME/rpmbuild" > ~/.rpmmacros

      - name: Prepare source package
        run: |
          FULL_VERSION=$(node -p "require('./package.json').version")
          PKG_VERSION=$(echo "$FULL_VERSION" | sed 's/-.*$//')
          PKG_NAME="orions-gate"
          tar czf ~/rpmbuild/SOURCES/${PKG_NAME}-${PKG_VERSION}.tar.gz \
            --exclude=node_modules --exclude=.git --exclude=release \
            --transform "s,^,${PKG_NAME}-${PKG_VERSION}/," .

      - name: Create SPEC file
        run: |
          FULL_VERSION=$(node -p "require('./package.json').version")
          # Split version and pre-release suffix (e.g., "2.0.0-alpha.0" -> "2.0.0" and "alpha.0")
          PKG_VERSION=$(echo "$FULL_VERSION" | sed 's/-.*$//')
          PKG_PRERELEASE=$(echo "$FULL_VERSION" | grep -oP '(?<=-).+' || echo "")
          
          # Determine release number
          if [ -z "$PKG_PRERELEASE" ]; then
            PKG_RELEASE="1%{?dist}"
          else
            # Convert pre-release format: "alpha.0" -> "0.alpha0"
            PKG_RELEASE="0.$(echo "$PKG_PRERELEASE" | tr -d '.-')%{?dist}"
          fi
          
          cat > ~/rpmbuild/SPECS/orions-gate.spec <<EOF
          Name:           orions-gate
          Version:        ${PKG_VERSION}
          Release:        ${PKG_RELEASE}
          Summary:        Transparent proxy web browser with VOT integration
          License:        MIT
          URL:            https://github.com/Cheviiot/Orions-Gate
          Source0:        %{name}-%{version}.tar.gz

          BuildRequires:  nodejs >= 20
          BuildRequires:  npm
          BuildRequires:  gcc-c++
          BuildRequires:  libX11-devel
          BuildRequires:  libXext-devel
          BuildRequires:  libxkbfile-devel
          BuildRequires:  ImageMagick

          Requires:       libX11
          Requires:       libXext
          Requires:       libxkbfile

          %description
          Orion's Gate is a transparent proxy web browser built on Electron 40,
          designed for secure content access with integrated Voice Over Translation.

          %prep
          %setup -q

          %build
          npm ci --legacy-peer-deps || npm install
          npm run generate-icons
          npm run build
          npx electron-builder --linux rpm --x64

          %install
          mkdir -p %{buildroot}/opt/%{name}
          mkdir -p %{buildroot}%{_bindir}
          mkdir -p %{buildroot}%{_datadir}/applications
          mkdir -p %{buildroot}%{_datadir}/icons/hicolor/512x512/apps
          
          # Copy application files
          cp -r release/linux-unpacked/* %{buildroot}/opt/%{name}/
          
          # Create symlink
          ln -s /opt/%{name}/%{name} %{buildroot}%{_bindir}/%{name}
          
          # Create desktop entry
          cat > %{buildroot}%{_datadir}/applications/%{name}.desktop <<DESKTOP
          [Desktop Entry]
          Name=Orion's Gate
          Comment=Transparent proxy web browser
          Exec=/opt/%{name}/%{name}
          Type=Application
          Icon=%{name}
          Categories=Network;WebBrowser;
          Terminal=false
          DESKTOP

          # Copy icon if exists
          if [ -f resources/icon.png ]; then
            cp resources/icon.png %{buildroot}%{_datadir}/icons/hicolor/512x512/apps/%{name}.png
          fi

          %files
          /opt/%{name}
          %{_bindir}/%{name}
          %{_datadir}/applications/%{name}.desktop
          %{_datadir}/icons/hicolor/512x512/apps/%{name}.png

          %changelog
          * $(LANG=C date "+%a %b %d %Y") CI Robot <ci@orionsgate.dev> ${PKG_VERSION}-${PKG_RELEASE}
          - Automated CI/CD build (version: ${FULL_VERSION})
          EOF

      - name: Build RPM
        run: rpmbuild -ba ~/rpmbuild/SPECS/orions-gate.spec

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-rpm-artifacts
          path: |
            ~/rpmbuild/RPMS/**/*.rpm
            ~/rpmbuild/SRPMS/*.src.rpm
          retention-days: 30

  windows:
    name: Windows (NSIS + MSI)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package.json

      - name: Install project dependencies
        run: |
          npm install
          npm run playwright:install

      - name: Generate icons
        run: npm run generate-icons

      - name: Build application
        run: npm run build

      - name: Package (NSIS + MSI)
        run: npx electron-builder --win nsis msi --config electron-builder.yml

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: release/**/*
          retention-days: 30

  altlinux:
    name: Alt Linux (RPM)
    runs-on: ubuntu-latest
    container:
      image: docker.io/alt:sisyphus
      options: --user root
    steps:
      - name: Install compatibility libraries
        run: |
          apt-get update
          apt-get install -y glibc glibc-pthread glibc-core

      - uses: actions/checkout@v4

      - name: Install build tools
        run: |
          apt-get install -y \
            curl ca-certificates git \
            rpm-build hasher gear rpmlint \
            python3 make gcc-c++ \
            libX11-devel libXext-devel libxkbfile-devel \
            ImageMagick sudo

      - name: Install Node.js from Alt Linux repo
        run: |
          apt-get install -y nodejs npm

      - name: Create build user
        run: |
          useradd -m builder
          chown -R builder:builder $PWD
          echo "root ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/root

      - name: Install project dependencies
        run: sudo -u builder npm install

      - name: Generate icons
        run: sudo -u builder npm run generate-icons

      - name: Build application
        run: sudo -u builder npm run build

      - name: Setup RPM build environment
        run: |
          sudo -u builder mkdir -p /home/builder/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          echo "%_topdir /home/builder/rpmbuild" | sudo -u builder tee /home/builder/.rpmmacros

      - name: Prepare source package
        run: |
          FULL_VERSION=$(node -p "require('./package.json').version")
          PKG_VERSION=$(echo "$FULL_VERSION" | sed 's/-.*$//')
          PKG_NAME="orions-gate"
          sudo -u builder tar czf /home/builder/rpmbuild/SOURCES/${PKG_NAME}-${PKG_VERSION}.tar.gz \
            --exclude=node_modules --exclude=.git --exclude=release \
            --transform "s,^,${PKG_NAME}-${PKG_VERSION}/," -C $PWD .

      - name: Create SPEC file
        run: |
          FULL_VERSION=$(node -p "require('./package.json').version")
          # Split version and pre-release suffix
          PKG_VERSION=$(echo "$FULL_VERSION" | sed 's/-.*$//')
          PKG_PRERELEASE=$(echo "$FULL_VERSION" | grep -oP '(?<=-).+' || echo "")
          
          # Determine release number for Alt Linux
          if [ -z "$PKG_PRERELEASE" ]; then
            PKG_RELEASE="alt1"
          else
            # Convert pre-release format: "alpha.0" -> "alt0.alpha0"
            PKG_RELEASE="alt0.$(echo "$PKG_PRERELEASE" | tr -d '.-')"
          fi
          
          cat > /home/builder/rpmbuild/SPECS/orions-gate.spec <<EOF
          Name:           orions-gate
          Version:        ${PKG_VERSION}
          Release:        ${PKG_RELEASE}
          Summary:        Transparent proxy web browser
          License:        MIT
          Group:          Networking/WWW
          URL:            https://github.com/Cheviiot/Orions-Gate
          Source0:        %{name}-%{version}.tar.gz

          BuildRequires:  rpm-build
          BuildRequires:  nodejs >= 20
          BuildRequires:  gcc-c++
          BuildRequires:  libX11-devel libXext-devel libxkbfile-devel
          BuildRequires:  ImageMagick

          %description
          Orion's Gate - transparent proxy browser with VOT integration.

          %prep
          %setup -q

          %build
          npm ci --legacy-peer-deps || npm install
          npm run generate-icons
          npm run build
          npx electron-builder --linux rpm --x64

          %install
          mkdir -p %{buildroot}/opt/%{name}
          mkdir -p %{buildroot}%{_bindir}
          mkdir -p %{buildroot}%{_datadir}/applications
          
          cp -r release/linux-unpacked/* %{buildroot}/opt/%{name}/
          ln -s /opt/%{name}/%{name} %{buildroot}%{_bindir}/%{name}
          
          cat > %{buildroot}%{_datadir}/applications/%{name}.desktop <<DESKTOP
          [Desktop Entry]
          Name=Orion's Gate
          Exec=/opt/%{name}/%{name}
          Type=Application
          Icon=%{name}
          Categories=Network;WebBrowser;
          DESKTOP

          %files
          /opt/%{name}
          %{_bindir}/%{name}
          %{_datadir}/applications/%{name}.desktop

          %changelog
          * $(LANG=C date "+%a %b %d %Y") CI Robot <ci@orionsgate.dev> ${PKG_VERSION}-${PKG_RELEASE}
          - Automated build (version: ${FULL_VERSION})
          EOF
          sudo chown builder:builder /home/builder/rpmbuild/SPECS/orions-gate.spec

      - name: Build RPM
        run: |
          sudo -u builder rpmbuild -ba /home/builder/rpmbuild/SPECS/orions-gate.spec

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: altlinux-rpm-artifacts
          path: |
            /home/builder/rpmbuild/RPMS/**/*.rpm
            /home/builder/rpmbuild/SRPMS/*.src.rpm
          retention-days: 30

